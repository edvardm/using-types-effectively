<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Edvard Majakari">
<meta name="dcterms.date" content="2025-04-09">
<meta name="keywords" content="typing, programming, python, mypy, type systems">

<title>Using Types Effectively</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="ute_files/libs/clipboard/clipboard.min.js"></script>
<script src="ute_files/libs/quarto-html/quarto.js"></script>
<script src="ute_files/libs/quarto-html/popper.min.js"></script>
<script src="ute_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ute_files/libs/quarto-html/anchor.min.js"></script>
<link href="ute_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ute_files/libs/quarto-html/quarto-syntax-highlighting-d4d76bf8491c20bad77d141916dc28e1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ute_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ute_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ute_files/libs/bootstrap/bootstrap-58195ada163f9b939e0c719e571d61e9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<style>
div.callout-fixme.callout {
  border-left-color: orange;
}
div.callout-fixme.callout-style-default > .callout-header {
  background-color: rgb(from orange r g b / 13%);
}
div.callout-fixme .callout-toggle::before {  background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgb(33, 37, 41)" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>');}
div.callout-fixme.callout-style-default .callout-icon::before, div.callout-fixme.callout-titled .callout-icon::before {
  content: '‚ö†Ô∏è';
  background-image: none;
}
div.callout-cs.callout {
  border-left-color: blue;
}
div.callout-cs.callout-style-default > .callout-header {
  background-color: rgb(from blue r g b / 13%);
}
div.callout-cs .callout-toggle::before {  background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgb(33, 37, 41)" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>');}
div.callout-cs.callout-style-default .callout-icon::before, div.callout-cs.callout-titled .callout-icon::before {
  content: 'üéì';
  background-image: none;
}
</style>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#acknowledgements" id="toc-acknowledgements" class="nav-link active" data-scroll-target="#acknowledgements">Acknowledgements</a></li>
  <li><a href="#enum-erate-and-conquer" id="toc-enum-erate-and-conquer" class="nav-link" data-scroll-target="#enum-erate-and-conquer">Enum-erate and conquer</a>
  <ul class="collapse">
  <li><a href="#with-literal" id="toc-with-literal" class="nav-link" data-scroll-target="#with-literal">with <code>Literal</code></a></li>
  <li><a href="#with-enum" id="toc-with-enum" class="nav-link" data-scroll-target="#with-enum">with <code>Enum</code></a></li>
  </ul></li>
  <li><a href="#choose-your-own-adtventure" id="toc-choose-your-own-adtventure" class="nav-link" data-scroll-target="#choose-your-own-adtventure">Choose your own ADTventure</a></li>
  <li><a href="#a-newtype-of-identity" id="toc-a-newtype-of-identity" class="nav-link" data-scroll-target="#a-newtype-of-identity">A NewType of identity</a></li>
  <li><a href="#generic-fantasy-inventory-system" id="toc-generic-fantasy-inventory-system" class="nav-link" data-scroll-target="#generic-fantasy-inventory-system">Generic fantasy inventory system</a>
  <ul class="collapse">
  <li><a href="#a-wild-functor-appears" id="toc-a-wild-functor-appears" class="nav-link" data-scroll-target="#a-wild-functor-appears">A wild functor appears!</a></li>
  </ul></li>
  <li><a href="#you-shall-not-pass-unless-valid" id="toc-you-shall-not-pass-unless-valid" class="nav-link" data-scroll-target="#you-shall-not-pass-unless-valid">You shall not pass (unless valid)</a></li>
  <li><a href="#in-a-state-of-denial" id="toc-in-a-state-of-denial" class="nav-link" data-scroll-target="#in-a-state-of-denial">In a state of denial</a>
  <ul class="collapse">
  <li><a href="#simple-approach" id="toc-simple-approach" class="nav-link" data-scroll-target="#simple-approach">Simple approach</a></li>
  <li><a href="#improved-approach-with-type-based-states" id="toc-improved-approach-with-type-based-states" class="nav-link" data-scroll-target="#improved-approach-with-type-based-states">Improved approach with type-based states</a></li>
  </ul></li>
  <li><a href="#ghosts-in-the-type-machine" id="toc-ghosts-in-the-type-machine" class="nav-link" data-scroll-target="#ghosts-in-the-type-machine">Ghosts in the type machine</a></li>
  <li><a href="#venturing-further" id="toc-venturing-further" class="nav-link" data-scroll-target="#venturing-further">Venturing further</a></li>
  <li><a href="#common-pitfalls" id="toc-common-pitfalls" class="nav-link" data-scroll-target="#common-pitfalls">Common pitfalls</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading">Further reading</a></li>
  
  </ul>
</nav>
</div>
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Using Types Effectively</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Edvard Majakari <a href="mailto:edvard+ute@rakettitiede.com" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 9, 2025</p>
    </div>
  </div>
  
    
  </div>
  

<div>
  <div class="keywords">
    <div class="block-title">Keywords</div>
    <p>typing, programming, python, mypy, type systems</p>
  </div>
</div>

</header>


<p>In this article, we‚Äôll explore practical ways to leverage static typing. Starting from basic union types to more refined concepts like Algebraic Data Types (ADTs) and finally Phantom types. To keep things a bit more interesting, we‚Äôll apply these ideas to a fantasy-themed dungeon crawler RPG setting, illustrating how thoughtful domain modeling can neatly sidestep entire classes of bugs.</p>
<p>The core idea here is straightforward yet powerful: <em>making invalid states unrepresentable</em> by just using <em>type system</em>. This clever strategy helps us catch numerous errors at compile-time (or, in Python‚Äôs case, during type analysis), significantly reducing the likelihood of bugs that might otherwise inconvenience end users.</p>
<p>While this principle shines brightest in compiled languages, excellent work accomplished by mypy developers can bring us most of the same benefits. Rather than just preventing trivial mistakes (like letters sneaking into postal codes), a well-structured type system can express complex, logical transitions without adding any runtime overhead. Done right, this approach doesn‚Äôt just prevent errors; it also makes code easier to read and maintain. It is also worth emphasizing that the type system described here is implemented by <code>mypy</code>, not Python itself.</p>
<p>Additionally, it can reduce or entirely eliminate certain forms of errors. If a condition simply <em>cannot occur</em> according to your types, there‚Äôs no need to test for it explicitly.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Examples assume Python 3.10+ to leverage the <code>match</code> statement and ML-style syntax for union types (<code>|</code>).</p>
</div>
</div>
<section id="acknowledgements" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h2>
<p>I really wish to thank Marko Saaresto for all good suggestions, ideas and support! I also need to express my gratitude for concise, but quite eye-opening explanations and corrections by our resident Type System Sensei Lauri Alanko.</p>
</section>
<section id="enum-erate-and-conquer" class="level2">
<h2 class="anchored" data-anchor-id="enum-erate-and-conquer">Enum-erate and conquer</h2>
<p>Core idea in typing is to constrain set of values in such a manner that (ideally) only legal values can be assigned. Dictionaries are very common datastructures in Python and often very convenient, but become easily problematic with more large codebases. Main issues often are related to strings used as keys with dictionaries.</p>
<p>To get started with our dungeon crawler game, assume our hero needs to be able to attack various monsters lurking in the darkness, we could come up with something like</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">def</span> attack_enemy(weapon: <span class="bu">str</span>, attack_type: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb1-2"><a href="#cb1-2"></a>    <span class="cf">return</span> {</span>
<span id="cb1-3"><a href="#cb1-3"></a>        <span class="st">"sword"</span>: {</span>
<span id="cb1-4"><a href="#cb1-4"></a>            <span class="st">"quick"</span>: <span class="dv">5</span>,</span>
<span id="cb1-5"><a href="#cb1-5"></a>            <span class="st">"strong"</span>: <span class="dv">10</span>,</span>
<span id="cb1-6"><a href="#cb1-6"></a>            <span class="st">"special"</span>: <span class="dv">15</span>,</span>
<span id="cb1-7"><a href="#cb1-7"></a>        },</span>
<span id="cb1-8"><a href="#cb1-8"></a>        <span class="st">"bow"</span>: {<span class="st">"quick"</span>: <span class="dv">3</span>, <span class="st">"strong"</span>: <span class="dv">7</span>, <span class="st">"special"</span>: <span class="dv">12</span>},</span>
<span id="cb1-9"><a href="#cb1-9"></a>        <span class="st">"staff"</span>: {</span>
<span id="cb1-10"><a href="#cb1-10"></a>            <span class="st">"quick"</span>: <span class="dv">2</span>,</span>
<span id="cb1-11"><a href="#cb1-11"></a>            <span class="st">"strong"</span>: <span class="dv">4</span>,</span>
<span id="cb1-12"><a href="#cb1-12"></a>            <span class="st">"special"</span>: <span class="dv">20</span>,</span>
<span id="cb1-13"><a href="#cb1-13"></a>        },</span>
<span id="cb1-14"><a href="#cb1-14"></a>    }[weapon][attack_type]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>I tend to avoid creating variables for things which are used only once; so instead of creating the dictionary and then returning an element from it, I just return the element directly. This saves me the trouble of inventing good names and I also know that variable is very likely used more than once (with the exception of constants and loop variables) ‚Äì unless using a variable would simplify it a lot; <em>lengthy</em> isn‚Äôt the same as <em>complex</em></p>
</div>
</div>
<p>Shown approach presents some regrettable limitations:</p>
<ul>
<li>No compile-time validation</li>
<li>Typos in string literals won‚Äôt be caught until runtime</li>
<li>No IDE autocompletion support</li>
</ul>
<p>Worst of all, it is not uncommon to see such dictionaries passed around multiple modules, some keys created dynamically by manipulating strings etc. In such cases it is often practically impossible to see what all values are possible, or even what is the structure of valid value (assuming dictionary contains nested data)</p>
<p>In particular, the type checker will not warn about <code>attack_enemy("scimitar", "special")</code> until runtime. One option to tackle the issue would be to change return value to <code>int | None</code> and use non-strict dictionary access, but then we would taint <em>all calls</em> and introduce potential None error, forcing callers to (often repeatedly) check for None, thus making code unnecessarily convoluted, or risk throwing <code>KeyError</code>.</p>
<section id="with-literal" class="level3">
<h3 class="anchored" data-anchor-id="with-literal">with <code>Literal</code></h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="im">from</span> typing <span class="im">import</span> Literal</span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="kw">def</span> attack_enemy(</span>
<span id="cb2-5"><a href="#cb2-5"></a>    weapon: Literal[<span class="st">"sword"</span>, <span class="st">"bow"</span>, <span class="st">"staff"</span>],</span>
<span id="cb2-6"><a href="#cb2-6"></a>    attack_type: Literal[<span class="st">"quick"</span>, <span class="st">"strong"</span>, <span class="st">"special"</span>],</span>
<span id="cb2-7"><a href="#cb2-7"></a>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb2-8"><a href="#cb2-8"></a>    <span class="cf">return</span> {</span>
<span id="cb2-9"><a href="#cb2-9"></a>        <span class="st">"sword"</span>: {</span>
<span id="cb2-10"><a href="#cb2-10"></a>            <span class="st">"quick"</span>: <span class="dv">5</span>,</span>
<span id="cb2-11"><a href="#cb2-11"></a>            <span class="st">"strong"</span>: <span class="dv">10</span>,</span>
<span id="cb2-12"><a href="#cb2-12"></a>            <span class="st">"special"</span>: <span class="dv">15</span>,</span>
<span id="cb2-13"><a href="#cb2-13"></a>        },</span>
<span id="cb2-14"><a href="#cb2-14"></a>        <span class="st">"bow"</span>: {<span class="st">"quick"</span>: <span class="dv">3</span>, <span class="st">"strong"</span>: <span class="dv">7</span>, <span class="st">"special"</span>: <span class="dv">12</span>},</span>
<span id="cb2-15"><a href="#cb2-15"></a>        <span class="st">"staff"</span>: {</span>
<span id="cb2-16"><a href="#cb2-16"></a>            <span class="st">"quick"</span>: <span class="dv">2</span>,</span>
<span id="cb2-17"><a href="#cb2-17"></a>            <span class="st">"strong"</span>: <span class="dv">4</span>,</span>
<span id="cb2-18"><a href="#cb2-18"></a>            <span class="st">"special"</span>: <span class="dv">20</span>,</span>
<span id="cb2-19"><a href="#cb2-19"></a>        },</span>
<span id="cb2-20"><a href="#cb2-20"></a>    }[weapon][attack_type]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Using <code>Literal</code> we define precisely which values are permissible, gaining compile-time validation via type checker. It enables IDE autocompletion, and documents valid values directly within the type system. The code becomes more maintainable, as addition of new values forces updating the type definition.</p>
</section>
<section id="with-enum" class="level3">
<h3 class="anchored" data-anchor-id="with-enum">with <code>Enum</code></h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="im">from</span> enum <span class="im">import</span> Enum</span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="kw">class</span> WeaponType(Enum):</span>
<span id="cb3-5"><a href="#cb3-5"></a>    SWORD <span class="op">=</span> <span class="st">"sword"</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>    BOW <span class="op">=</span> <span class="st">"bow"</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>    STAFF <span class="op">=</span> <span class="st">"staff"</span></span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="kw">class</span> AttackType(Enum):</span>
<span id="cb3-11"><a href="#cb3-11"></a>    QUICK <span class="op">=</span> <span class="st">"quick"</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>    STRONG <span class="op">=</span> <span class="st">"strong"</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>    SPECIAL <span class="op">=</span> <span class="st">"special"</span></span>
<span id="cb3-14"><a href="#cb3-14"></a></span>
<span id="cb3-15"><a href="#cb3-15"></a></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="kw">def</span> attack_enemy(weapon: WeaponType, attack_type: AttackType) <span class="op">-&gt;</span> <span class="bu">int</span> <span class="op">|</span> <span class="va">None</span>:</span>
<span id="cb3-17"><a href="#cb3-17"></a>    <span class="cf">return</span> {</span>
<span id="cb3-18"><a href="#cb3-18"></a>        WeaponType.SWORD: {</span>
<span id="cb3-19"><a href="#cb3-19"></a>            AttackType.QUICK: <span class="dv">5</span>,</span>
<span id="cb3-20"><a href="#cb3-20"></a>            AttackType.STRONG: <span class="dv">10</span>,</span>
<span id="cb3-21"><a href="#cb3-21"></a>            AttackType.SPECIAL: <span class="dv">15</span>,</span>
<span id="cb3-22"><a href="#cb3-22"></a>        },</span>
<span id="cb3-23"><a href="#cb3-23"></a>        WeaponType.BOW: {</span>
<span id="cb3-24"><a href="#cb3-24"></a>            AttackType.QUICK: <span class="dv">3</span>,</span>
<span id="cb3-25"><a href="#cb3-25"></a>            AttackType.STRONG: <span class="dv">7</span>,</span>
<span id="cb3-26"><a href="#cb3-26"></a>            AttackType.SPECIAL: <span class="dv">12</span>,</span>
<span id="cb3-27"><a href="#cb3-27"></a>        },</span>
<span id="cb3-28"><a href="#cb3-28"></a>        WeaponType.STAFF: {</span>
<span id="cb3-29"><a href="#cb3-29"></a>            AttackType.QUICK: <span class="dv">2</span>,</span>
<span id="cb3-30"><a href="#cb3-30"></a>            AttackType.STRONG: <span class="dv">4</span>,</span>
<span id="cb3-31"><a href="#cb3-31"></a>            AttackType.SPECIAL: <span class="dv">20</span>,</span>
<span id="cb3-32"><a href="#cb3-32"></a>        },</span>
<span id="cb3-33"><a href="#cb3-33"></a>    }[weapon][attack_type]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This final version employing enums offers additional advantages. Values are grouped in more prominent fashion with an explicit namespace. Enum values may be modified without disrupting serialized data. Enums are self-documenting, may easily include docstrings (as values), while still providing full IDE autocompletion.</p>
</section>
</section>
<section id="choose-your-own-adtventure" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="choose-your-own-adtventure">Choose your own ADTventure</h2>
<p>We already saw how enums can be used to constrain allowed values to prevent typos or other coarse errors. In general, what we often want to do though is to create <em>Algebraic Data Types</em> (<a href="https://en.wikipedia.org/wiki/Algebraic_data_type">ADT</a>s) to model idea of varying options without making code more fragile or convoluted with unnecessary checks.</p>
<p>Let‚Äôs define some terms first: while unions and sum types are often used interchangeably, they have a crucial difference. A union type specifies a value that can be exactly one of several specified types, but without explicit tags distinguishing the variants. A sum type explicitly tags each variant, making it impossible to confuse one variant with another (often called <em>tagged union</em> for that very reason).</p>
<p>In other words, a sum type is a union type with a constraint that only one variant can be held at a time. Sum types are also known as tagged unions, discriminated unions, or algebraic data types (ADTs).</p>
<p>To show how useful ADTs are, let‚Äôs start simple problem of being able to <code>use_item()</code> during our adventures, starting with</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="im">from</span> typing <span class="im">import</span> TypedDict</span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="kw">class</span> Item(TypedDict):</span>
<span id="cb4-5"><a href="#cb4-5"></a>    <span class="bu">type</span>: <span class="bu">str</span></span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="kw">def</span> use_item(item: Item) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb4-9"><a href="#cb4-9"></a>    <span class="cf">if</span> item[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"potion"</span>:</span>
<span id="cb4-10"><a href="#cb4-10"></a>        <span class="cf">return</span> <span class="ss">f"Grabbed potion with color </span><span class="sc">{</span>item<span class="sc">.</span>get(<span class="st">'color'</span>, <span class="st">'unknown'</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>    <span class="cf">elif</span> item[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"scroll"</span>:</span>
<span id="cb4-12"><a href="#cb4-12"></a>        <span class="cf">return</span> <span class="ss">f"Grabbed scroll with spell </span><span class="sc">{</span>item<span class="sc">.</span>get(<span class="st">'spell_name'</span>, <span class="st">'unknown'</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>    <span class="cf">elif</span> item[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"weapon"</span>:</span>
<span id="cb4-14"><a href="#cb4-14"></a>        <span class="cf">return</span> <span class="ss">f"Grabbed weapon named </span><span class="sc">{</span>item<span class="sc">.</span>get(<span class="st">'name'</span>, <span class="st">'unknown'</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb4-15"><a href="#cb4-15"></a>    <span class="cf">else</span>:</span>
<span id="cb4-16"><a href="#cb4-16"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unknown item type: </span><span class="sc">{</span>item<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>While implementation might look safe due to use of <code>TypedDict</code> with <code>type: str</code> key, it is not very safe. While much better than having just <code>dict[str, ...]</code> we could have similar other dicts with <code>type</code> key, and we would be able to pass that to <code>use_item()</code> as long as the dictionary would have the same structure as <code>Item</code>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>While Python‚Äôs <code>|</code> syntax creates a union, we are using it here to model a sum type, where each variant is a <em>distinct, disjoint case</em> of an overarching concept. In some languages (e.g., <a href="https://www.haskell.org/">Haskell</a>, Rust, F#, OCaml, Elm..), sum types are first-class language features with explicit syntax. Python lacks direct support, but we can <em>emulate</em> sum types with combined use of unions and dataclasses.</p>
</div>
</div>
<div class="no-row-height column-margin column-container"><span class="margin-aside callout-margin-content">If there was a God, He would probably be hacking new extensions for Glasgow Haskell Compiler (GHC). Just sayin‚Äô</span></div><p>Let‚Äôs examine a more refined implementation required to deal with data type with varying (sub-type) constructors, demonstrating sum types:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="at">@dataclass</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="kw">class</span> Potion:</span>
<span id="cb5-6"><a href="#cb5-6"></a>    name: <span class="bu">str</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>    healing: <span class="bu">int</span></span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="at">@dataclass</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="kw">class</span> Scroll:</span>
<span id="cb5-12"><a href="#cb5-12"></a>    name: <span class="bu">str</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>    spell: <span class="bu">str</span></span>
<span id="cb5-14"><a href="#cb5-14"></a></span>
<span id="cb5-15"><a href="#cb5-15"></a></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="at">@dataclass</span></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="kw">class</span> Weapon:</span>
<span id="cb5-18"><a href="#cb5-18"></a>    name: <span class="bu">str</span></span>
<span id="cb5-19"><a href="#cb5-19"></a>    damage: <span class="bu">int</span></span>
<span id="cb5-20"><a href="#cb5-20"></a></span>
<span id="cb5-21"><a href="#cb5-21"></a></span>
<span id="cb5-22"><a href="#cb5-22"></a>Item <span class="op">=</span> Potion <span class="op">|</span> Scroll <span class="op">|</span> Weapon</span>
<span id="cb5-23"><a href="#cb5-23"></a></span>
<span id="cb5-24"><a href="#cb5-24"></a></span>
<span id="cb5-25"><a href="#cb5-25"></a><span class="kw">def</span> use_item(item: Item) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb5-26"><a href="#cb5-26"></a>    <span class="cf">match</span> item:</span>
<span id="cb5-27"><a href="#cb5-27"></a>        <span class="cf">case</span> Potion(name<span class="op">=</span>name, healing<span class="op">=</span>healing):</span>
<span id="cb5-28"><a href="#cb5-28"></a>            <span class="cf">return</span> <span class="ss">f"Grabbed healing potion </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">, heals </span><span class="sc">{</span>healing<span class="sc">}</span><span class="ss"> HP"</span></span>
<span id="cb5-29"><a href="#cb5-29"></a>        <span class="cf">case</span> Scroll(name<span class="op">=</span>name, spell<span class="op">=</span>spell):</span>
<span id="cb5-30"><a href="#cb5-30"></a>            <span class="cf">return</span> <span class="ss">f"Grabbed scroll of </span><span class="sc">{</span>spell<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb5-31"><a href="#cb5-31"></a>        <span class="cf">case</span> Weapon(name<span class="op">=</span>name, damage<span class="op">=</span>damage):</span>
<span id="cb5-32"><a href="#cb5-32"></a>            <span class="cf">return</span> <span class="ss">f"Grabbed </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">, dealing </span><span class="sc">{</span>damage<span class="sc">}</span><span class="ss"> damage)"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This implementation offers several advantages over our previous dictionary-based approach. First, the type checker provides static verification, ensuring that <code>use_item()</code> only accepts our defined classes. The code becomes more readable as each type‚Äôs properties are explicitly defined in the class structure. When we need to extend our system with new variants (such as adding an <code>Armor</code> class), the type checker would immediately alert us if we haven‚Äôt handled the new case. Perhaps most elegantly, the <code>match</code> statement works harmoniously with our sum type, providing a clean and exhaustive way to handle all possible variants without nested conditionals.</p>
<div class="page-columns page-full"><p>The last point is worth emphasizing: <code>match</code> plays particularly well here because there is no need for catch-all <code>case _</code> branch. So unless the condition is trivial, we would prefer <code>match</code> over <code>if</code>. The code is also more clear to read, as each case is necessarily compared against the same, single expression.</p><div class="no-row-height column-margin column-container"><span class="margin-aside">With <em>if</em> statement, each <em>elif</em>-branch could have completely unrelated, different condition. In some cases it is not clear unless each branch is read very carefully; <em>match</em> can make this obvious</span></div></div>
<p>We would also get much better autocompletion for most IDEs/editors by using dataclasses over (even) typed dictionaries.</p>
</section>
<section id="a-newtype-of-identity" class="level2">
<h2 class="anchored" data-anchor-id="a-newtype-of-identity">A NewType of identity</h2>
<p><code>NewType</code> is a powerful feature for distinguishing semantically different values that share the same base type. While similar to <code>Literal</code>s in that it constrains values, it works at the type level rather than the value level.</p>
<p>In our dungeon crawler, we might have different types of IDs that are all integers at runtime but represent different concepts in our domain. For example, a character‚Äôs health points and their level are both integers, but they represent fundamentally different things. Let‚Äôs see how we can use <code>NewType</code> to prevent mixing these up:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="im">from</span> typing <span class="im">import</span> NewType</span>
<span id="cb6-2"><a href="#cb6-2"></a></span>
<span id="cb6-3"><a href="#cb6-3"></a>MonsterID <span class="op">=</span> NewType(<span class="st">"MonsterID"</span>, <span class="bu">int</span>)</span>
<span id="cb6-4"><a href="#cb6-4"></a>PlayerID <span class="op">=</span> NewType(<span class="st">"PlayerID"</span>, <span class="bu">int</span>)</span>
<span id="cb6-5"><a href="#cb6-5"></a></span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="kw">def</span> damage_monster(monster_id: MonsterID, amount: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb6-8"><a href="#cb6-8"></a>    <span class="bu">print</span>(<span class="ss">f"Damaging monster </span><span class="sc">{</span>monster_id<span class="sc">}</span><span class="ss"> by </span><span class="sc">{</span>amount<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-9"><a href="#cb6-9"></a>    <span class="cf">return</span> amount</span>
<span id="cb6-10"><a href="#cb6-10"></a></span>
<span id="cb6-11"><a href="#cb6-11"></a></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="kw">def</span> heal_player(player_id: PlayerID, amount: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb6-13"><a href="#cb6-13"></a>    <span class="bu">print</span>(<span class="ss">f"Healing player </span><span class="sc">{</span>player_id<span class="sc">}</span><span class="ss"> by </span><span class="sc">{</span>amount<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-14"><a href="#cb6-14"></a></span>
<span id="cb6-15"><a href="#cb6-15"></a></span>
<span id="cb6-16"><a href="#cb6-16"></a>monster_id <span class="op">=</span> MonsterID(<span class="dv">42</span>)</span>
<span id="cb6-17"><a href="#cb6-17"></a>player_id <span class="op">=</span> PlayerID(<span class="dv">1</span>)</span>
<span id="cb6-18"><a href="#cb6-18"></a></span>
<span id="cb6-19"><a href="#cb6-19"></a>damage_monster(monster_id, <span class="dv">10</span>)</span>
<span id="cb6-20"><a href="#cb6-20"></a>heal_player(player_id, <span class="dv">5</span>)</span>
<span id="cb6-21"><a href="#cb6-21"></a></span>
<span id="cb6-22"><a href="#cb6-22"></a>damage_monster(player_id, <span class="dv">10</span>)  <span class="co"># type: ignore[arg-type]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This approach provides more type safety, as the type checker will catch any attempts to mix up different types of IDs with zero runtime overhead, since <code>NewType</code> is erased at runtime. It also makes code more self-documenting, as the type system prominently indicates what kind of ID is expected.</p>
</section>
<section id="generic-fantasy-inventory-system" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="generic-fantasy-inventory-system">Generic fantasy inventory system</h2>
<p>Generics let you define reusable data structures that preserve type information. They build upon the concept of union types by allowing us to work with collections of any type while maintaining type safety.</p>
<p>In our dungeon crawler, we might want to create a type-safe inventory system that can hold different types of items while ensuring we can‚Äôt mix incompatible items. Let‚Äôs see how generics can help:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="im">from</span> typing <span class="im">import</span> Generic, TypeVar, List</span>
<span id="cb7-3"><a href="#cb7-3"></a></span>
<span id="cb7-4"><a href="#cb7-4"></a>T <span class="op">=</span> TypeVar(<span class="st">"T"</span>)</span>
<span id="cb7-5"><a href="#cb7-5"></a></span>
<span id="cb7-6"><a href="#cb7-6"></a></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="at">@dataclass</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="kw">class</span> SpellBook:</span>
<span id="cb7-9"><a href="#cb7-9"></a>    name: <span class="bu">str</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>    arcane_level: <span class="bu">int</span></span>
<span id="cb7-11"><a href="#cb7-11"></a></span>
<span id="cb7-12"><a href="#cb7-12"></a></span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="at">@dataclass</span></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="kw">class</span> Item:</span>
<span id="cb7-15"><a href="#cb7-15"></a>    name: <span class="bu">str</span></span>
<span id="cb7-16"><a href="#cb7-16"></a>    value: <span class="bu">int</span></span>
<span id="cb7-17"><a href="#cb7-17"></a></span>
<span id="cb7-18"><a href="#cb7-18"></a></span>
<span id="cb7-19"><a href="#cb7-19"></a><span class="kw">class</span> Inventory(Generic[T]):</span>
<span id="cb7-20"><a href="#cb7-20"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb7-21"><a href="#cb7-21"></a>        <span class="va">self</span>.items: List[T] <span class="op">=</span> []</span>
<span id="cb7-22"><a href="#cb7-22"></a></span>
<span id="cb7-23"><a href="#cb7-23"></a>    <span class="kw">def</span> add(<span class="va">self</span>, item: T) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb7-24"><a href="#cb7-24"></a>        <span class="va">self</span>.items.append(item)</span>
<span id="cb7-25"><a href="#cb7-25"></a></span>
<span id="cb7-26"><a href="#cb7-26"></a>    <span class="kw">def</span> get_all(<span class="va">self</span>) <span class="op">-&gt;</span> List[T]:</span>
<span id="cb7-27"><a href="#cb7-27"></a>        <span class="cf">return</span> <span class="bu">list</span>(<span class="va">self</span>.items)</span>
<span id="cb7-28"><a href="#cb7-28"></a></span>
<span id="cb7-29"><a href="#cb7-29"></a></span>
<span id="cb7-30"><a href="#cb7-30"></a>books <span class="op">=</span> Inventory[SpellBook]()</span>
<span id="cb7-31"><a href="#cb7-31"></a>books.add(SpellBook(<span class="st">"Fireball"</span>, <span class="dv">10</span>))</span>
<span id="cb7-32"><a href="#cb7-32"></a></span>
<span id="cb7-33"><a href="#cb7-33"></a>items <span class="op">=</span> Inventory[Item]()</span>
<span id="cb7-34"><a href="#cb7-34"></a>items.add(Item(<span class="st">"Health Potion"</span>, <span class="dv">50</span>))</span>
<span id="cb7-35"><a href="#cb7-35"></a></span>
<span id="cb7-36"><a href="#cb7-36"></a>items.add(SpellBook(<span class="st">"Call Lightning"</span>, <span class="dv">8</span>))  <span class="co"># type: ignore[arg-type]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This example demonstrates several key benefits of generics. First, the type system knows exactly what kind of items are in each inventory, preserving type information throughout your code. Second, the type checker ensures we can‚Äôt mix incompatible items, catching errors at compile time rather than runtime. Third, the same inventory code works with any type of item, making it highly reusable across your codebase. Finally, you get full IDE support with autocompletion for item-specific methods, improving developer productivity and reducing errors.</p>
<p>As a common example, generics allow us to write flexible functions such as <code>filter</code>, <code>fold</code> (<code>reduce</code> in Python) and <code>map</code>. These are all <em>parametrically polymorphic, type-preserving</em> functions.</p>
<section id="a-wild-functor-appears" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="a-wild-functor-appears">A wild functor appears!</h3>
<div class="page-columns page-full"><p>Related to generics, there exists a concept so powerful I can‚Äôt help not mentioning it. It is called a <em>functor</em>, which generalizes composition of ‚Äúplain‚Äù functions over values which can be ‚Äúmapped over‚Äù. Functors are rather ubiquitous structures in functional programming languages</p><div class="no-row-height column-margin column-container"><span class="margin-aside">Every FP fanboy rants about Monads. But Functors are even more useful, and more generic! Not to mention that every monad is also a functor.</span></div></div>
<p>In programming, a functor <code>F</code> is a type constructor (like <code>List</code>, <code>Result</code>, <code>Tree</code>‚Ä¶), <em>and</em> a function <code>f</code> which operates on normal (unlifted) values of type <code>T</code>, returning new function which works on ‚Äúlifted‚Äù values <code>F(T)</code>. Functors are <em>incredibly powerful</em> constructs when a language has built-in support for those, providing developer</p>
<ul>
<li><strong>Composition without boilerplate</strong> allowing operations on collections without manually writing loops or comprehensions</li>
<li><strong>Type-safe transformations</strong> with errors caught at compile time</li>
<li><strong>Consistent interfaces</strong>: uniform API to work with arbitrarily different container types</li>
<li><strong>Code reusability</strong> as functions written for simple types can be automatically ‚Äúlifted‚Äù to work on containers of those types</li>
</ul>
<p>So what is it then? Are functors just clever type constructors, or merely functions conforming to an interface? Neither. A functor is an example of a <em>type class</em><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> ‚Äì concept roughly comparable to interfaces in many mainstream languages, but with a crucial distinction; while a type implementing an interface must explicitly declare that relationship, type classes are defined <em>independently of the types they apply to</em>. A type <em>conforms</em> to given type class when the developer provides appropriate declaration, typically by creating an <em>instance</em> of the type class or supplying an <em>implementation</em> that satisfies requirements of said class. This makes the relationship entirely decoupled from the original type definition. In Rust and Scala, very similar concept appears as <em>traits</em>.</p>
<div class="page-columns page-full"><p>While functors would not work well with type systems available for Python, several compiled languages provide these powerful abstractions either natively (Haskell, OCaml, ReasonML) or through well-integrated libraries (like <a href="https://typelevel.org/cats/">Cats</a> in Scala or <a href="https://arrow-kt.io/">Arrow</a> in Kotlin).</p><div class="no-row-height column-margin column-container"><span class="margin-aside">This would require higher-kind types (HKTs in type-theory jargon), because functors map <em>types</em> to another type</span></div></div>
</section>
</section>
<section id="you-shall-not-pass-unless-valid" class="level2">
<h2 class="anchored" data-anchor-id="you-shall-not-pass-unless-valid">You shall not pass (unless valid)</h2>
<p>When you must handle data of uncertain shape (e.g., a JSON payload), <em>type guards</em> let you refine <code>Any</code> or union types using runtime checks.</p>
<p>In our dungeon crawler, we might receive item data from a network API or configuration file. The data structure is known but not guaranteed at compile time. Let‚Äôs see how type guards can help us safely handle this:</p>
<div class="sourceCode" id="annotated-cell-8"><pre class="sourceCode numberSource python code-annotation-code number-lines code-with-copy"><code class="sourceCode python"><span id="annotated-cell-8-1"><a href="#annotated-cell-8-1"></a><span class="im">from</span> typing <span class="im">import</span> Any, TypeGuard, TypedDict</span>
<span id="annotated-cell-8-2"><a href="#annotated-cell-8-2"></a></span>
<span id="annotated-cell-8-3"><a href="#annotated-cell-8-3"></a></span>
<span id="annotated-cell-8-4"><a href="#annotated-cell-8-4"></a><span class="kw">class</span> MonsterData(TypedDict):</span>
<span id="annotated-cell-8-5"><a href="#annotated-cell-8-5"></a>    name: <span class="bu">str</span></span>
<span id="annotated-cell-8-6"><a href="#annotated-cell-8-6"></a>    difficulty: <span class="bu">int</span></span>
<span id="annotated-cell-8-7"><a href="#annotated-cell-8-7"></a></span>
<span id="annotated-cell-8-8"><a href="#annotated-cell-8-8"></a></span>
<span id="annotated-cell-8-9"><a href="#annotated-cell-8-9"></a><span class="kw">def</span> is_monster_data(data: Any) <span class="op">-&gt;</span> TypeGuard[MonsterData]:</span>
<span id="annotated-cell-8-10"><a href="#annotated-cell-8-10"></a>    <span class="cf">match</span> data:</span>
<span id="annotated-cell-8-11"><a href="#annotated-cell-8-11"></a>        case {<span class="st">"name"</span>: <span class="bu">str</span>(), <span class="st">"difficulty"</span>: <span class="bu">int</span>(), <span class="op">**</span>_rest}:</span>
<span id="annotated-cell-8-12"><a href="#annotated-cell-8-12"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="annotated-cell-8-13"><a href="#annotated-cell-8-13"></a>        <span class="cf">case</span> _:</span>
<span id="annotated-cell-8-14"><a href="#annotated-cell-8-14"></a>            <span class="cf">return</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>line 4: <code>TypedDict</code> makes the expected structure explicit instead of using raw <code>dict[str, ...]</code></li>
<li>line 11: This ensures ‚Äúname‚Äù and ‚Äúdifficulty‚Äù exist and have the correct types, but does NOT check whether all keys are strings</li>
<li>line 12: Type signature declares return value to be <code>TypeGuard[MonsterData]</code>, even though it is obviously <code>bool</code>. This is what mypy documentation calls <a href="https://mypy.readthedocs.io/en/latest/type_narrowing.html#type-guards">‚Äúsmart booleans‚Äù</a>: If result is <code>True</code>, the type checker will assume <code>data : MonsterData</code></li>
</ul>
<p>Type guards provide some important benefits. They allow us to <em>narrow</em> types by helping the type checker to understand the specific type after validation has occurred, thus maintaining type safety by preserving type information throughout your program. While that check happens at runtime, it still beats isinstance checks.</p>
<p>You‚Äôll find type guards particularly valuable in several, common scenarios. When working with external APIs or data sources, they help in ensuring the data conforms to your expectations. When parsing configuration files or user input, they validate the structure before you use it.</p>
</section>
<section id="in-a-state-of-denial" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="in-a-state-of-denial">In a state of denial</h2>
<p>Beyond data shapes, we can also address <em>logical states</em>. This builds upon the ideas from Union Types and Type Guards to create a more expressive type to represent <em>state machine</em>.</p>
<section id="simple-approach" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="simple-approach">Simple approach</h3>
<div class="page-columns page-full"><p>Let‚Äôs consider a scenario with magical artifacts which can be in different states: <em>unholy</em>, <em>normal</em> or <em>blessed</em>. In addition, casting certain spell can make such item <em>radiant</em> emanating aura of healing. We might start with something like</p><div class="no-row-height column-margin column-container"><span class="margin-aside"><em>Obviously</em> unholy items cannot produce healing effects!</span></div></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass, replace</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="im">from</span> enum <span class="im">import</span> Enum, auto</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="im">import</span> time</span>
<span id="cb8-4"><a href="#cb8-4"></a></span>
<span id="cb8-5"><a href="#cb8-5"></a></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="kw">class</span> State(Enum):</span>
<span id="cb8-7"><a href="#cb8-7"></a>    UNHOLY <span class="op">=</span> auto()</span>
<span id="cb8-8"><a href="#cb8-8"></a>    NORMAL <span class="op">=</span> auto()</span>
<span id="cb8-9"><a href="#cb8-9"></a>    BLESSED <span class="op">=</span> auto()</span>
<span id="cb8-10"><a href="#cb8-10"></a></span>
<span id="cb8-11"><a href="#cb8-11"></a></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="at">@dataclass</span>(frozen<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="kw">class</span> Artifact:</span>
<span id="cb8-14"><a href="#cb8-14"></a>    name: <span class="bu">str</span></span>
<span id="cb8-15"><a href="#cb8-15"></a>    power: <span class="bu">int</span></span>
<span id="cb8-16"><a href="#cb8-16"></a>    state: State</span>
<span id="cb8-17"><a href="#cb8-17"></a>    healing_power: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span>  <span class="co"># Only used when state is RADIANT</span></span>
<span id="cb8-18"><a href="#cb8-18"></a></span>
<span id="cb8-19"><a href="#cb8-19"></a></span>
<span id="cb8-20"><a href="#cb8-20"></a><span class="kw">def</span> bless_artifact(artifact: Artifact) <span class="op">-&gt;</span> Artifact:</span>
<span id="cb8-21"><a href="#cb8-21"></a>    <span class="bu">print</span>(<span class="ss">f"Playing blessing animation for </span><span class="sc">{</span>artifact<span class="sc">.</span>name<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb8-22"><a href="#cb8-22"></a>    time.sleep(<span class="dv">1</span>)  <span class="co"># Simulate expensive animation</span></span>
<span id="cb8-23"><a href="#cb8-23"></a>    <span class="bu">print</span>(<span class="st">"..."</span>)</span>
<span id="cb8-24"><a href="#cb8-24"></a>    <span class="bu">print</span>(<span class="st">"Blessing animation complete!"</span>)</span>
<span id="cb8-25"><a href="#cb8-25"></a></span>
<span id="cb8-26"><a href="#cb8-26"></a>    <span class="cf">if</span> artifact.state <span class="kw">not</span> <span class="kw">in</span> (State.NORMAL, State.UNHOLY):</span>
<span id="cb8-27"><a href="#cb8-27"></a>        <span class="bu">print</span>(<span class="st">"Can only bless normal or unholy artifacts"</span>)</span>
<span id="cb8-28"><a href="#cb8-28"></a>        <span class="cf">return</span> artifact</span>
<span id="cb8-29"><a href="#cb8-29"></a></span>
<span id="cb8-30"><a href="#cb8-30"></a>    <span class="co"># Blessed artifacts get a healing bonus when made radiant</span></span>
<span id="cb8-31"><a href="#cb8-31"></a>    <span class="cf">return</span> replace(artifact, healing_power<span class="op">=</span>artifact.power <span class="op">*</span> <span class="dv">2</span>)</span>
<span id="cb8-32"><a href="#cb8-32"></a></span>
<span id="cb8-33"><a href="#cb8-33"></a></span>
<span id="cb8-34"><a href="#cb8-34"></a><span class="kw">def</span> make_radiant(artifact: Artifact) <span class="op">-&gt;</span> Artifact:</span>
<span id="cb8-35"><a href="#cb8-35"></a>    <span class="cf">if</span> artifact.state <span class="kw">in</span> (State.BLESSED, State.NORMAL):</span>
<span id="cb8-36"><a href="#cb8-36"></a>        <span class="cf">return</span> replace(artifact, healing_power<span class="op">=</span>artifact.power)</span>
<span id="cb8-37"><a href="#cb8-37"></a>    <span class="cf">else</span>:</span>
<span id="cb8-38"><a href="#cb8-38"></a>        <span class="bu">print</span>(<span class="st">"Only normal or Blessed artifacts can be made radiant"</span>)</span>
<span id="cb8-39"><a href="#cb8-39"></a>        <span class="cf">return</span> artifact</span>
<span id="cb8-40"><a href="#cb8-40"></a></span>
<span id="cb8-41"><a href="#cb8-41"></a></span>
<span id="cb8-42"><a href="#cb8-42"></a><span class="bu">print</span>(<span class="st">"First shalt thou take out the Holy Pin."</span>)</span>
<span id="cb8-43"><a href="#cb8-43"></a>unholy_grenade <span class="op">=</span> Artifact(</span>
<span id="cb8-44"><a href="#cb8-44"></a>    name<span class="op">=</span><span class="st">"Holy Hand Grenade of Antioch"</span>,</span>
<span id="cb8-45"><a href="#cb8-45"></a>    power<span class="op">=</span><span class="dv">1000</span>,</span>
<span id="cb8-46"><a href="#cb8-46"></a>    state<span class="op">=</span>State.UNHOLY,</span>
<span id="cb8-47"><a href="#cb8-47"></a>)</span>
<span id="cb8-48"><a href="#cb8-48"></a></span>
<span id="cb8-49"><a href="#cb8-49"></a><span class="bu">print</span>(<span class="st">"Then shalt thou count to three, no more, no less."</span>)</span>
<span id="cb8-50"><a href="#cb8-50"></a>normal_grenade <span class="op">=</span> bless_artifact(unholy_grenade)</span>
<span id="cb8-51"><a href="#cb8-51"></a></span>
<span id="cb8-52"><a href="#cb8-52"></a><span class="bu">print</span>(</span>
<span id="cb8-53"><a href="#cb8-53"></a>    <span class="st">"Four shalt thou not count, neither count thou two, "</span></span>
<span id="cb8-54"><a href="#cb8-54"></a>    <span class="st">"excepting that thou then proceed to three. Five is right out."</span></span>
<span id="cb8-55"><a href="#cb8-55"></a>)</span>
<span id="cb8-56"><a href="#cb8-56"></a>blessed_grenade <span class="op">=</span> bless_artifact(normal_grenade)</span>
<span id="cb8-57"><a href="#cb8-57"></a></span>
<span id="cb8-58"><a href="#cb8-58"></a><span class="bu">print</span>(</span>
<span id="cb8-59"><a href="#cb8-59"></a>    <span class="st">"Once the number three, being the third number, be reached, then lobbest thou "</span></span>
<span id="cb8-60"><a href="#cb8-60"></a>    <span class="st">"thy Holy Hand Grenade of Antioch towards thy foe, who, being naughty in My sight, shall snuff it."</span></span>
<span id="cb8-61"><a href="#cb8-61"></a>)</span>
<span id="cb8-62"><a href="#cb8-62"></a></span>
<span id="cb8-63"><a href="#cb8-63"></a>radiant_grenade <span class="op">=</span> make_radiant(blessed_grenade)</span>
<span id="cb8-64"><a href="#cb8-64"></a></span>
<span id="cb8-65"><a href="#cb8-65"></a>bless_artifact(radiant_grenade)  <span class="co"># but this was already blessed..</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="page-columns page-full"><p>Unnecessary extra call to bless would not crash the system, but surely you can imagine cases where calling a function accidentally too often might be extremely harmful. In this case it only executes ‚Äòexpensive‚Äô animation twice. But we have more severe issues:</p><div class="no-row-height column-margin column-container"><span class="margin-aside">Which is why <em>idempotent functions</em> are often desirable</span></div></div>
<ul>
<li>State transitions are validated at runtime, meaning errors only surface when the code is executed</li>
<li>The single <code>Artifact</code> class with a state field makes it possible to create invalid combinations (e.g., a blessed artifact with healing power)</li>
<li>Type information is lost, making it harder for the type checker to catch errors</li>
<li>The code requires manual state checking and error handling</li>
</ul>
</section>
<section id="improved-approach-with-type-based-states" class="level3">
<h3 class="anchored" data-anchor-id="improved-approach-with-type-based-states">Improved approach with type-based states</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="im">from</span> typing <span class="im">import</span> overload, TypeVar</span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="im">import</span> time</span>
<span id="cb9-4"><a href="#cb9-4"></a></span>
<span id="cb9-5"><a href="#cb9-5"></a></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="at">@dataclass</span>(frozen<span class="op">=</span><span class="va">True</span>, kw_only<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="kw">class</span> BaseArtifact:</span>
<span id="cb9-8"><a href="#cb9-8"></a>    name: <span class="bu">str</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>    power: <span class="bu">int</span></span>
<span id="cb9-10"><a href="#cb9-10"></a></span>
<span id="cb9-11"><a href="#cb9-11"></a></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="at">@dataclass</span>(frozen<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="kw">class</span> UnholyArtifact(BaseArtifact): ...</span>
<span id="cb9-14"><a href="#cb9-14"></a></span>
<span id="cb9-15"><a href="#cb9-15"></a></span>
<span id="cb9-16"><a href="#cb9-16"></a><span class="at">@dataclass</span>(frozen<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-17"><a href="#cb9-17"></a><span class="kw">class</span> NormalArtifact(BaseArtifact): ...</span>
<span id="cb9-18"><a href="#cb9-18"></a></span>
<span id="cb9-19"><a href="#cb9-19"></a></span>
<span id="cb9-20"><a href="#cb9-20"></a><span class="at">@dataclass</span>(frozen<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-21"><a href="#cb9-21"></a><span class="kw">class</span> BlessedArtifact(BaseArtifact): ...</span>
<span id="cb9-22"><a href="#cb9-22"></a></span>
<span id="cb9-23"><a href="#cb9-23"></a></span>
<span id="cb9-24"><a href="#cb9-24"></a><span class="at">@dataclass</span>(frozen<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-25"><a href="#cb9-25"></a><span class="kw">class</span> RadiantArtifact(BaseArtifact):</span>
<span id="cb9-26"><a href="#cb9-26"></a>    healing_power: <span class="bu">int</span></span>
<span id="cb9-27"><a href="#cb9-27"></a></span>
<span id="cb9-28"><a href="#cb9-28"></a></span>
<span id="cb9-29"><a href="#cb9-29"></a><span class="at">@dataclass</span>(frozen<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-30"><a href="#cb9-30"></a><span class="kw">class</span> RadiantBlessedArtifact(BaseArtifact):</span>
<span id="cb9-31"><a href="#cb9-31"></a>    healing_power: <span class="bu">int</span></span>
<span id="cb9-32"><a href="#cb9-32"></a></span>
<span id="cb9-33"><a href="#cb9-33"></a></span>
<span id="cb9-34"><a href="#cb9-34"></a>T <span class="op">=</span> TypeVar(<span class="st">"T"</span>, UnholyArtifact, NormalArtifact, RadiantArtifact)</span>
<span id="cb9-35"><a href="#cb9-35"></a></span>
<span id="cb9-36"><a href="#cb9-36"></a></span>
<span id="cb9-37"><a href="#cb9-37"></a><span class="at">@overload</span></span>
<span id="cb9-38"><a href="#cb9-38"></a><span class="kw">def</span> bless_artifact(artifact: UnholyArtifact) <span class="op">-&gt;</span> NormalArtifact: ...</span>
<span id="cb9-39"><a href="#cb9-39"></a><span class="at">@overload</span></span>
<span id="cb9-40"><a href="#cb9-40"></a><span class="kw">def</span> bless_artifact(artifact: NormalArtifact) <span class="op">-&gt;</span> BlessedArtifact: ...</span>
<span id="cb9-41"><a href="#cb9-41"></a><span class="at">@overload</span></span>
<span id="cb9-42"><a href="#cb9-42"></a><span class="kw">def</span> bless_artifact(artifact: RadiantArtifact) <span class="op">-&gt;</span> RadiantBlessedArtifact: ...</span>
<span id="cb9-43"><a href="#cb9-43"></a></span>
<span id="cb9-44"><a href="#cb9-44"></a></span>
<span id="cb9-45"><a href="#cb9-45"></a><span class="kw">def</span> bless_artifact(</span>
<span id="cb9-46"><a href="#cb9-46"></a>    artifact: T,</span>
<span id="cb9-47"><a href="#cb9-47"></a>) <span class="op">-&gt;</span> NormalArtifact <span class="op">|</span> BlessedArtifact <span class="op">|</span> RadiantBlessedArtifact:</span>
<span id="cb9-48"><a href="#cb9-48"></a>    <span class="bu">print</span>(<span class="ss">f"Playing blessing animation for </span><span class="sc">{</span>artifact<span class="sc">.</span>name<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb9-49"><a href="#cb9-49"></a>    time.sleep(<span class="dv">1</span>)  <span class="co"># Simulate expensive animation</span></span>
<span id="cb9-50"><a href="#cb9-50"></a>    <span class="bu">print</span>(<span class="st">"... Blessing animation complete!"</span>)</span>
<span id="cb9-51"><a href="#cb9-51"></a></span>
<span id="cb9-52"><a href="#cb9-52"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(artifact, UnholyArtifact):</span>
<span id="cb9-53"><a href="#cb9-53"></a>        <span class="cf">return</span> NormalArtifact(name<span class="op">=</span>artifact.name, power<span class="op">=</span>artifact.power)</span>
<span id="cb9-54"><a href="#cb9-54"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(artifact, NormalArtifact):</span>
<span id="cb9-55"><a href="#cb9-55"></a>        <span class="cf">return</span> BlessedArtifact(name<span class="op">=</span>artifact.name, power<span class="op">=</span>artifact.power)</span>
<span id="cb9-56"><a href="#cb9-56"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(artifact, RadiantArtifact):</span>
<span id="cb9-57"><a href="#cb9-57"></a>        <span class="cf">return</span> RadiantBlessedArtifact(</span>
<span id="cb9-58"><a href="#cb9-58"></a>            name<span class="op">=</span>artifact.name,</span>
<span id="cb9-59"><a href="#cb9-59"></a>            power<span class="op">=</span>artifact.power,</span>
<span id="cb9-60"><a href="#cb9-60"></a>            healing_power<span class="op">=</span>artifact.healing_power,</span>
<span id="cb9-61"><a href="#cb9-61"></a>        )</span>
<span id="cb9-62"><a href="#cb9-62"></a>    <span class="cf">else</span>:</span>
<span id="cb9-63"><a href="#cb9-63"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Invalid artifact for blessing"</span>)</span>
<span id="cb9-64"><a href="#cb9-64"></a></span>
<span id="cb9-65"><a href="#cb9-65"></a></span>
<span id="cb9-66"><a href="#cb9-66"></a>U <span class="op">=</span> TypeVar(<span class="st">"U"</span>, NormalArtifact, BlessedArtifact)</span>
<span id="cb9-67"><a href="#cb9-67"></a></span>
<span id="cb9-68"><a href="#cb9-68"></a></span>
<span id="cb9-69"><a href="#cb9-69"></a><span class="at">@overload</span></span>
<span id="cb9-70"><a href="#cb9-70"></a><span class="kw">def</span> make_radiant(artifact: NormalArtifact) <span class="op">-&gt;</span> RadiantArtifact: ...</span>
<span id="cb9-71"><a href="#cb9-71"></a><span class="at">@overload</span></span>
<span id="cb9-72"><a href="#cb9-72"></a><span class="kw">def</span> make_radiant(artifact: BlessedArtifact) <span class="op">-&gt;</span> RadiantBlessedArtifact: ...</span>
<span id="cb9-73"><a href="#cb9-73"></a></span>
<span id="cb9-74"><a href="#cb9-74"></a></span>
<span id="cb9-75"><a href="#cb9-75"></a><span class="kw">def</span> make_radiant(artifact: U) <span class="op">-&gt;</span> RadiantArtifact <span class="op">|</span> RadiantBlessedArtifact:</span>
<span id="cb9-76"><a href="#cb9-76"></a>    <span class="cf">match</span> artifact:</span>
<span id="cb9-77"><a href="#cb9-77"></a>        <span class="cf">case</span> NormalArtifact():</span>
<span id="cb9-78"><a href="#cb9-78"></a>            <span class="cf">return</span> RadiantArtifact(</span>
<span id="cb9-79"><a href="#cb9-79"></a>                name<span class="op">=</span>artifact.name, power<span class="op">=</span>artifact.power, healing_power<span class="op">=</span>artifact.power</span>
<span id="cb9-80"><a href="#cb9-80"></a>            )</span>
<span id="cb9-81"><a href="#cb9-81"></a>        <span class="cf">case</span> BlessedArtifact():</span>
<span id="cb9-82"><a href="#cb9-82"></a>            <span class="cf">return</span> RadiantBlessedArtifact(</span>
<span id="cb9-83"><a href="#cb9-83"></a>                name<span class="op">=</span>artifact.name,</span>
<span id="cb9-84"><a href="#cb9-84"></a>                power<span class="op">=</span>artifact.power,</span>
<span id="cb9-85"><a href="#cb9-85"></a>                healing_power<span class="op">=</span>artifact.power <span class="op">*</span> <span class="dv">2</span>,</span>
<span id="cb9-86"><a href="#cb9-86"></a>            )</span>
<span id="cb9-87"><a href="#cb9-87"></a></span>
<span id="cb9-88"><a href="#cb9-88"></a></span>
<span id="cb9-89"><a href="#cb9-89"></a>unholy_grenade <span class="op">=</span> UnholyArtifact(name<span class="op">=</span><span class="st">"(Not so) Holy Hand Grenade of Antioch"</span>, power<span class="op">=</span><span class="dv">1024</span>)</span>
<span id="cb9-90"><a href="#cb9-90"></a></span>
<span id="cb9-91"><a href="#cb9-91"></a><span class="co"># must fail to type-check</span></span>
<span id="cb9-92"><a href="#cb9-92"></a>make_radiant(unholy_grenade)  <span class="co"># type: ignore</span></span>
<span id="cb9-93"><a href="#cb9-93"></a></span>
<span id="cb9-94"><a href="#cb9-94"></a>normal_grenade <span class="op">=</span> bless_artifact(unholy_grenade)</span>
<span id="cb9-95"><a href="#cb9-95"></a>blessed_grenade <span class="op">=</span> bless_artifact(normal_grenade)</span>
<span id="cb9-96"><a href="#cb9-96"></a></span>
<span id="cb9-97"><a href="#cb9-97"></a>make_radiant(normal_grenade)</span>
<span id="cb9-98"><a href="#cb9-98"></a>make_radiant(blessed_grenade)</span>
<span id="cb9-99"><a href="#cb9-99"></a></span>
<span id="cb9-100"><a href="#cb9-100"></a><span class="co"># must fail to type-check</span></span>
<span id="cb9-101"><a href="#cb9-101"></a>bless_artifact(blessed_grenade)  <span class="co"># type: ignore</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now we ensure that artifact transformations follows strict rules by taking better advantage of types. The overloaded <code>bless_artifact()</code> function demonstrates how we can use the type system to enforce different behaviors based on input type.</p>
<p>In particular, now we have encoded <em>valid state transitions</em> dictated by domain logic, by just using the type system.</p>
<p>Now the type system provides strong guarantees about our artifact system, ensuring that only valid state transitions are possible, eg. by preventing attempts to bless already blessed artifacts. Each artifact state has its own specific properties and behaviors clearly defined by its class structure. Most importantly, invalid combinations of states simply cannot exist in our program.</p>
<p>There‚Äôs one big issue though: at worst, cardinality of types we need to represent all possible states is a Cartesian product of all the types we‚Äôve declared. Creating dataclasses for each combination would quickly become unwieldy, awkward even. Type signatures are quite convoluted otherwise as well.</p>
</section>
</section>
<section id="ghosts-in-the-type-machine" class="level2">
<h2 class="anchored" data-anchor-id="ghosts-in-the-type-machine">Ghosts in the type machine</h2>
<p><em>Phantom types</em> are most useful when we need generic operations that apply to a family of related types, allowing us to create even more sophisticated type-level constraints. While technically idea is quite simple, it is clever enough to elaborate on that a bit.</p>
<p>Let‚Äôs look at a simple example first, conveying the key idea. Phantom type is literally a type which appears only in the type signature, ie. there is no matching instance of that type present anywhere. Back to our hero, assume we‚Äôd want to ensure any spell must be checked to be safe via some function, and we would want to achieve this with types. We could of course create extra types for each possible combination, but as seen before, this becomes awkward very quickly. Phantom types allow us to ‚Äútag‚Äù any existing types with meaningul symbols:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> TypeVar, Generic, Callable</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> TypeVar(<span class="st">"T"</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>Marker <span class="op">=</span> TypeVar(<span class="st">"Marker"</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Phantom(Generic[T, Marker]):</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    v: T</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co"># fmt: off</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Safe: ...  <span class="co"># actual phantom type</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SafetyCheckError(<span class="pp">Exception</span>): ...</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># fmt: on</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate(value: T, pred: Callable[[T], <span class="bu">bool</span>]) <span class="op">-&gt;</span> Phantom[T, Safe]:</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pred(value):</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Phantom(value)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> SafetyCheckError(<span class="ss">f"Validation failed for value: </span><span class="sc">{</span>value<span class="sc">!r}</span><span class="ss">"</span>)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_scroll(scroll: Phantom[<span class="bu">str</span>, Safe]) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Reading scroll </span><span class="sc">{</span>scroll<span class="sc">.</span>v<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main() <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    unchecked_scroll <span class="op">=</span> <span class="st">"enchant weapon'; DROP TABLE INVENTORY; --"</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        safe_scroll <span class="op">=</span> validate(</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>            unchecked_scroll.strip(), <span class="kw">lambda</span> s: <span class="bu">bool</span>(re.match(<span class="vs">r"^[a-z ]$"</span>, s))</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        read_scroll(safe_scroll)  <span class="co"># ok</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> SafetyCheckError <span class="im">as</span> e:</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fails to typecheck as desired</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    read_scroll(unchecked_scroll)  <span class="co"># type: ignore[arg-type]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For more serious use of phantom types in Python, you might want to check out <a href="https://github.com/antonagestam/phantom-types/">https://github.com/antonagestam/phantom-types/</a></p>
</div>
</div>
<p>Pay extra attention to our <code>Phantom</code> class wrapper. It is extremely simple dataclass with only sigle field <code>v</code>, containing the actual value. But there is also this type variable <code>Marker</code> which doesn‚Äôt appear anywhere in the class definition. This is exactly the idea! In <code>read_scroll()</code> function it allows us to convince the type checker that if the function doesn‚Äôt throw, then our scroll is guaranteed to be safe.</p>
<p>Revisiting our slightly less trivial artifact system, the explosion of types needed to handle all potential combinations is the main issue: we needed separate types (classes!) for almost every combination. Phantom types are very suitable here, as they allow us to refine the type focusing on one particular aspect only ‚Äì denoted by the tag/marker we use:</p>
<div class="sourceCode" id="annotated-cell-12"><pre class="sourceCode python code-annotation-code code-with-copy"><code class="sourceCode python"><span id="annotated-cell-12-1"><a href="#annotated-cell-12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass, replace</span>
<span id="annotated-cell-12-2"><a href="#annotated-cell-12-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> NewType, TypeVar, Generic, overload, Any</span>
<span id="annotated-cell-12-3"><a href="#annotated-cell-12-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="annotated-cell-12-4"><a href="#annotated-cell-12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-5"><a href="#annotated-cell-12-5" aria-hidden="true" tabindex="-1"></a>Unholy <span class="op">=</span> NewType(<span class="st">"Unholy"</span>, <span class="bu">object</span>)</span>
<span id="annotated-cell-12-6"><a href="#annotated-cell-12-6" aria-hidden="true" tabindex="-1"></a>Normal <span class="op">=</span> NewType(<span class="st">"Normal"</span>, <span class="bu">object</span>)</span>
<span id="annotated-cell-12-7"><a href="#annotated-cell-12-7" aria-hidden="true" tabindex="-1"></a>Blessed <span class="op">=</span> NewType(<span class="st">"Blessed"</span>, <span class="bu">object</span>)</span>
<span id="annotated-cell-12-8"><a href="#annotated-cell-12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-9"><a href="#annotated-cell-12-9" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> TypeVar(<span class="st">"T"</span>, Unholy, Normal, Blessed)</span>
<span id="annotated-cell-12-10"><a href="#annotated-cell-12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-11"><a href="#annotated-cell-12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-12"><a href="#annotated-cell-12-12" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span>(frozen<span class="op">=</span><span class="va">True</span>)</span>
<span id="annotated-cell-12-13"><a href="#annotated-cell-12-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BaseArtifact(Generic[T]):</span>
<span id="annotated-cell-12-14"><a href="#annotated-cell-12-14" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span></span>
<span id="annotated-cell-12-15"><a href="#annotated-cell-12-15" aria-hidden="true" tabindex="-1"></a>    power: <span class="bu">int</span></span>
<span id="annotated-cell-12-16"><a href="#annotated-cell-12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-17"><a href="#annotated-cell-12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-18"><a href="#annotated-cell-12-18" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span>(frozen<span class="op">=</span><span class="va">True</span>)</span>
<span id="annotated-cell-12-19"><a href="#annotated-cell-12-19" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Artifact(BaseArtifact[T]): ...</span>
<span id="annotated-cell-12-20"><a href="#annotated-cell-12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-21"><a href="#annotated-cell-12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-22"><a href="#annotated-cell-12-22" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span>(frozen<span class="op">=</span><span class="va">True</span>)</span>
<span id="annotated-cell-12-23"><a href="#annotated-cell-12-23" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RadiantArtifact(BaseArtifact[T]):</span>
<span id="annotated-cell-12-24"><a href="#annotated-cell-12-24" aria-hidden="true" tabindex="-1"></a>    healing_power: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="annotated-cell-12-25"><a href="#annotated-cell-12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-26"><a href="#annotated-cell-12-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-27"><a href="#annotated-cell-12-27" aria-hidden="true" tabindex="-1"></a>ArtifactType <span class="op">=</span> Artifact[T] <span class="op">|</span> RadiantArtifact[T]</span>
<span id="annotated-cell-12-28"><a href="#annotated-cell-12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-29"><a href="#annotated-cell-12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-30"><a href="#annotated-cell-12-30" aria-hidden="true" tabindex="-1"></a><span class="at">@overload</span></span>
<span id="annotated-cell-12-31"><a href="#annotated-cell-12-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bless_artifact(artifact: Artifact[Unholy]) <span class="op">-&gt;</span> Artifact[Normal]: ...</span>
<span id="annotated-cell-12-32"><a href="#annotated-cell-12-32" aria-hidden="true" tabindex="-1"></a><span class="at">@overload</span></span>
<span id="annotated-cell-12-33"><a href="#annotated-cell-12-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bless_artifact(artifact: Artifact[Normal]) <span class="op">-&gt;</span> Artifact[Blessed]: ...</span>
<span id="annotated-cell-12-34"><a href="#annotated-cell-12-34" aria-hidden="true" tabindex="-1"></a><span class="at">@overload</span></span>
<span id="annotated-cell-12-35"><a href="#annotated-cell-12-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bless_artifact(</span>
<span id="annotated-cell-12-36"><a href="#annotated-cell-12-36" aria-hidden="true" tabindex="-1"></a>    artifact: RadiantArtifact[Normal],</span>
<span id="annotated-cell-12-37"><a href="#annotated-cell-12-37" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> RadiantArtifact[Blessed]: ...</span>
<span id="annotated-cell-12-38"><a href="#annotated-cell-12-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-39"><a href="#annotated-cell-12-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-40"><a href="#annotated-cell-12-40" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bless_artifact(artifact: ArtifactType[T]) <span class="op">-&gt;</span> ArtifactType:  <span class="co"># type: ignore[type-arg]</span></span>
<span id="annotated-cell-12-41"><a href="#annotated-cell-12-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Playing blessing animation for </span><span class="sc">{</span>artifact<span class="sc">.</span>name<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="annotated-cell-12-42"><a href="#annotated-cell-12-42" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">1</span>)</span>
<span id="annotated-cell-12-43"><a href="#annotated-cell-12-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"..."</span>)</span>
<span id="annotated-cell-12-44"><a href="#annotated-cell-12-44" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Blessing animation complete!"</span>)</span>
<span id="annotated-cell-12-45"><a href="#annotated-cell-12-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-46"><a href="#annotated-cell-12-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> replace(artifact)</span>
<span id="annotated-cell-12-47"><a href="#annotated-cell-12-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-48"><a href="#annotated-cell-12-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-49"><a href="#annotated-cell-12-49" aria-hidden="true" tabindex="-1"></a><span class="at">@overload</span></span>
<span id="annotated-cell-12-50"><a href="#annotated-cell-12-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_radiant(artifact: Artifact[Normal]) <span class="op">-&gt;</span> RadiantArtifact[Normal]: ...</span>
<span id="annotated-cell-12-51"><a href="#annotated-cell-12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-52"><a href="#annotated-cell-12-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-53"><a href="#annotated-cell-12-53" aria-hidden="true" tabindex="-1"></a><span class="at">@overload</span></span>
<span id="annotated-cell-12-54"><a href="#annotated-cell-12-54" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_radiant(artifact: Artifact[Blessed]) <span class="op">-&gt;</span> RadiantArtifact[Blessed]: ...</span>
<span id="annotated-cell-12-55"><a href="#annotated-cell-12-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-56"><a href="#annotated-cell-12-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-57"><a href="#annotated-cell-12-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_radiant(artifact: Any) <span class="op">-&gt;</span> Any:</span>
<span id="annotated-cell-12-58"><a href="#annotated-cell-12-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> RadiantArtifact(</span>
<span id="annotated-cell-12-59"><a href="#annotated-cell-12-59" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span>artifact.name, power<span class="op">=</span>artifact.power, healing_power<span class="op">=</span>artifact.power</span>
<span id="annotated-cell-12-60"><a href="#annotated-cell-12-60" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-12-61"><a href="#annotated-cell-12-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-62"><a href="#annotated-cell-12-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-63"><a href="#annotated-cell-12-63" aria-hidden="true" tabindex="-1"></a><span class="at">@overload</span></span>
<span id="annotated-cell-12-64"><a href="#annotated-cell-12-64" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> use_artifact(artifact: Artifact[Unholy]) <span class="op">-&gt;</span> <span class="va">None</span>: ...</span>
<span id="annotated-cell-12-65"><a href="#annotated-cell-12-65" aria-hidden="true" tabindex="-1"></a><span class="at">@overload</span></span>
<span id="annotated-cell-12-66"><a href="#annotated-cell-12-66" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> use_artifact(artifact: Artifact[Normal]) <span class="op">-&gt;</span> <span class="va">None</span>: ...</span>
<span id="annotated-cell-12-67"><a href="#annotated-cell-12-67" aria-hidden="true" tabindex="-1"></a><span class="at">@overload</span></span>
<span id="annotated-cell-12-68"><a href="#annotated-cell-12-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> use_artifact(artifact: Artifact[Blessed]) <span class="op">-&gt;</span> <span class="va">None</span>: ...</span>
<span id="annotated-cell-12-69"><a href="#annotated-cell-12-69" aria-hidden="true" tabindex="-1"></a><span class="at">@overload</span></span>
<span id="annotated-cell-12-70"><a href="#annotated-cell-12-70" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> use_artifact(artifact: RadiantArtifact[Normal]) <span class="op">-&gt;</span> <span class="va">None</span>: ...</span>
<span id="annotated-cell-12-71"><a href="#annotated-cell-12-71" aria-hidden="true" tabindex="-1"></a><span class="at">@overload</span></span>
<span id="annotated-cell-12-72"><a href="#annotated-cell-12-72" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> use_artifact(artifact: RadiantArtifact[Blessed]) <span class="op">-&gt;</span> <span class="va">None</span>: ...</span>
<span id="annotated-cell-12-73"><a href="#annotated-cell-12-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-74"><a href="#annotated-cell-12-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-75"><a href="#annotated-cell-12-75" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> use_artifact(artifact: ArtifactType[Any]) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="annotated-cell-12-76"><a href="#annotated-cell-12-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">match</span> artifact:</span>
<span id="annotated-cell-12-77"><a href="#annotated-cell-12-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> RadiantArtifact(name<span class="op">=</span>name, power<span class="op">=</span>power, healing_power<span class="op">=</span>healing):</span>
<span id="annotated-cell-12-78"><a href="#annotated-cell-12-78" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Using radiant artifact </span><span class="sc">{</span>name<span class="op">=</span><span class="sc">}</span><span class="ss"> (power=</span><span class="sc">{</span>power<span class="sc">}</span><span class="ss">, healing=</span><span class="sc">{</span>healing<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="annotated-cell-12-79"><a href="#annotated-cell-12-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> Artifact(name<span class="op">=</span>name, power<span class="op">=</span>power):</span>
<span id="annotated-cell-12-80"><a href="#annotated-cell-12-80" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Using standard artifact </span><span class="sc">{</span>name<span class="op">=</span><span class="sc">}</span><span class="ss"> (power=</span><span class="sc">{</span>power<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="annotated-cell-12-81"><a href="#annotated-cell-12-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-82"><a href="#annotated-cell-12-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-83"><a href="#annotated-cell-12-83" aria-hidden="true" tabindex="-1"></a>unholy_grenade <span class="op">=</span> Artifact[Unholy](  <span class="co"># for some reason it was unholy when we found it..</span></span>
<span id="annotated-cell-12-84"><a href="#annotated-cell-12-84" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"(Not so) Holy Hand Grenade of Antioch"</span>,</span>
<span id="annotated-cell-12-85"><a href="#annotated-cell-12-85" aria-hidden="true" tabindex="-1"></a>    power<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="annotated-cell-12-86"><a href="#annotated-cell-12-86" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-12-87"><a href="#annotated-cell-12-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-88"><a href="#annotated-cell-12-88" aria-hidden="true" tabindex="-1"></a>normal_grenade <span class="op">=</span> bless_artifact(unholy_grenade)</span>
<span id="annotated-cell-12-89"><a href="#annotated-cell-12-89" aria-hidden="true" tabindex="-1"></a>blessed_grenade <span class="op">=</span> bless_artifact(normal_grenade)</span>
<span id="annotated-cell-12-90"><a href="#annotated-cell-12-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-91"><a href="#annotated-cell-12-91" aria-hidden="true" tabindex="-1"></a><span class="co"># must fail to type check</span></span>
<span id="annotated-cell-12-92"><a href="#annotated-cell-12-92" aria-hidden="true" tabindex="-1"></a>blessed_grenade <span class="op">=</span> bless_artifact(blessed_grenade)  <span class="co"># type: ignore</span></span>
<span id="annotated-cell-12-93"><a href="#annotated-cell-12-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-94"><a href="#annotated-cell-12-94" aria-hidden="true" tabindex="-1"></a>radiant_normal <span class="op">=</span> make_radiant(normal_grenade)</span>
<span id="annotated-cell-12-95"><a href="#annotated-cell-12-95" aria-hidden="true" tabindex="-1"></a>radiant_blessed <span class="op">=</span> make_radiant(blessed_grenade)</span>
<span id="annotated-cell-12-96"><a href="#annotated-cell-12-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-97"><a href="#annotated-cell-12-97" aria-hidden="true" tabindex="-1"></a><span class="co"># must fail to type check</span></span>
<span id="annotated-cell-12-98"><a href="#annotated-cell-12-98" aria-hidden="true" tabindex="-1"></a>make_radiant(unholy_grenade)  <span class="co"># type: ignore</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Phantom types provide significant benefits over the previous implementation. By utilizing single <code>Artifact</code> class with type parameters, we avoid the combinatorial explosion of classes that would otherwise be necessary to represent all possible states. The phantom types <code>Unholy</code>, <code>Normal</code> and <code>Blessed</code> allow us to maintain strong type safety while allowing other properties to remain independent and composable. We can freely combine different states without creating dedicated classes for each combination! Despite this flexibility, the type system continues to enforce valid state transitions through carefully defined overloaded functions. Perhaps most importantly, phantom types introduce zero runtime overhead since they exist purely at the type-checking level and are erased during compilation.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Using <code>--strict</code> with mypy is probably necessary for any working phantom type implementation. Not that we would not recommend using that in any case for any mission-critical software.</p>
</div>
</div>
</section>
<section id="venturing-further" class="level2">
<h2 class="anchored" data-anchor-id="venturing-further">Venturing further</h2>
<p>There are many more advanced concepts in type systems that we haven‚Äôt covered here. For example:</p>
<ul>
<li><strong>Generalized Algebraic Datatypes</strong>: GADTs extend ADTs, allowing constructors‚Äô result types to depend on input argument types, enabling more precise type-level constraints and stronger compile-time guarantees</li>
<li><strong>Dependent Types</strong>: Types that depend on other types</li>
<li><strong>Type Inference</strong>: Automatically determining types based on usage</li>
<li><strong>Type-Level Programming</strong>: Programming at the level of types rather than values</li>
</ul>
</section>
<section id="common-pitfalls" class="level2">
<h2 class="anchored" data-anchor-id="common-pitfalls">Common pitfalls</h2>
<p>After toying with some typing tricks, let‚Äôs quickly touch on some common unfortunate practises many Python developers tend to make even when working with critical codebases:</p>
<ul>
<li><p><strong>Overusing <code>Any</code> and vague types</strong>. While liberally sprinkling code with <code>Any</code> might silence type-checker warnings, it also defeats the very purpose of having type annotations. Being overly permissive easily leads to subtle bugs lurking undetected.</p></li>
<li><p><strong>Neglecting strict mode</strong>. Many developers miss out by not enabling stricter settings in their type checker, like mypy‚Äôs <code>--strict</code>. This leniency leaves unnecessary room for error.</p></li>
<li><p><strong>Abuse of isinstance</strong> While often quick way to ensure something is called for only appropriate types, usually such run-time checks could be turned into compile- (or build-) time checks</p></li>
<li><p><strong>Validating the same thing multiple times</strong>. Especially common with Optional values, there are many ways to avoid this, some of which were shown in this article.</p></li>
</ul>
<p>The core objective of effective typing isn‚Äôt just error detection, but <em>clarity</em> and <em>maintainability</em>. Well-designed types can make the code easier to understand, reducing cognitive overhead. However, it may be worth noting that poorly designed or overly complex annotations can have the opposite effect. If your annotations start obscuring your logic rather than clarifying it, consider simplifying your approach.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Using types effectively can greatly enhance the robustness and maintainability of your code by enabling you to catch errors at compile time<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>We began with the simple idea of replacing arbitrary dictionaries with fixed data structures, strategy that not only guards against coarse errors, but also improves readability and makes large codebases easier to extend. Ultimately, we demonstrated how mypy can model valid state transitions by emulating <em>sum types</em> with unions and dataclasses, and <em>phantom types</em> by combining sum types with <code>NewType</code> and <code>Generics</code>, all without making the implementation impractically convoluted. While some of these constructs are more ergonomic in statically compiled languages, mypy is powerful enough to provide Python developers with a rich toolkit for achieving much stronger type safety.</p>
<p>To summarize, consider using</p>
<ul>
<li>enums for constrained values</li>
<li>union types with dataclasses for basic adts* union types allow you to model multiple possible type</li>
<li>newtype for domain-specific types with common concrete type</li>
<li>generics for type-safe collections</li>
<li>type guards for runtime validation</li>
<li>phantom types for expressing multiple, independent extra constraints</li>
</ul>
<p>And finally, likely the most powerful idea: eliminate invalid states by <strong>expressing valid state transitions using the type system</strong>.</p>
</section>
<section id="further-reading" class="level2">
<h2 class="anchored" data-anchor-id="further-reading">Further reading</h2>
<p>For more information on type systems and their applications, consider the following resources:</p>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-harper2009tspl" class="csl-entry" role="listitem">
Harper, Robert. 2009. <span>‚ÄúType Systems in Programming Languages.‚Äù</span> 2009. <a href="https://people.mpi-sws.org/~dreyer/ats/papers/harper-tspl.pdf">https://people.mpi-sws.org/~dreyer/ats/papers/harper-tspl.pdf</a>.
</div>
<div id="ref-king2019parse" class="csl-entry" role="listitem">
King, Alexis. 2019. <span>‚ÄúParse, Don‚Äôt Validate.‚Äù</span> 2019. <a href="https://lexi-lambda.github.io/blog/2019/11/05/parse-don-t-validate/">https://lexi-lambda.github.io/blog/2019/11/05/parse-don-t-validate/</a>.
</div>
<div id="ref-minsky2017caml" class="csl-entry" role="listitem">
Minsky, Yaron. 2017. <span>‚ÄúCaml Trading: Experiences in Functional Programming on Wall Street.‚Äù</span> The Monad Reader, Issue 7. 2017. <a href="https://wiki.haskell.org/wikiupload/0/03/TMR-Issue7.pdf">https://wiki.haskell.org/wikiupload/0/03/TMR-Issue7.pdf</a>.
</div>
<div id="ref-noonan2020ghosts" class="csl-entry" role="listitem">
Noonan, Matt. 2020. <span>‚ÄúGhosts of Departed Proofs.‚Äù</span> 2020. <a href="https://kataskeue.com/gdp.pdf">https://kataskeue.com/gdp.pdf</a>.
</div>
<div id="ref-pierce2002types" class="csl-entry" role="listitem">
Pierce, Benjamin C. 2002. <em>Types and Programming Languages</em>. MIT Press.
</div>
<div id="ref-wlaschin2020designing" class="csl-entry" role="listitem">
Wlaschin, Scott. 2020. <span>‚ÄúDesigning with Types: Making Illegal States Unrepresentable.‚Äù</span> 2020. <a href="https://fsharpforfunandprofit.com/posts/designing-with-types-making-illegal-states-unrepresentable/">https://fsharpforfunandprofit.com/posts/designing-with-types-making-illegal-states-unrepresentable/</a>.
</div>
</div>
</section>



<div id="quarto-appendix" class="default"><section id="appendix-a" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">APPENDIX A</h2><div class="quarto-appendix-contents">

<p>You can download all <a href="./static/code.zip" class="download">code examples</a> used here</p>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>not to confuse with classes in OOP<a href="#fnref1" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn2"><p>-&gt; here: when type-checking, but I‚Äôm sure we get that already<a href="#fnref2" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>